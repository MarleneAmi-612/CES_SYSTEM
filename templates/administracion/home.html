{% load static %}
<link rel="icon" href="{% static 'favicon/favicon.ico' %}">
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Panel | Administraci√≥n CES</title>

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="{% static 'css/admin.css' %}?v={{ now|date:'U' }}">
</head>
<body class="bg-orbs">
  <div class="shell">
    <!-- Topbar -->
    <header class="topbar">
      <div class="brand" aria-label="CES Administraci√≥n">
        <span class="dot" aria-hidden="true"></span>
        <strong>CES</strong> ¬∑ Administraci√≥n
      </div>

      <div class="top-actions">
        <!-- üîé Buscador -->
        <form class="search" method="get" action="{% url 'administracion:home' %}" role="search" aria-label="Buscar solicitudes">
          <input name="q" type="search" placeholder="Buscar por correo, nombre, CURP, programa‚Ä¶" value="{{ q }}">
        </form>

        <!-- Usuario / Men√∫ -->
        <div class="user user-has-menu">
          <button id="userMenuBtn" class="userbtn" type="button" aria-haspopup="menu" aria-expanded="false">
            <span class="avatar">
              {{ request.user.username|default:request.user.email|first|upper }}
            </span>
            <span class="usermeta">
              <span class="uname">{{ request.user.username|default:request.user.email }}</span>
              <span class="uemail">{{ request.user.email }}</span>
            </span>
            <svg class="caret" width="16" height="16" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M7 10l5 5 5-5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>

          <nav id="userMenu" class="menu" role="menu" aria-label="Men√∫ de usuario">
            <a class="mi" role="menuitem" href="{% url 'administracion:home' %}">
              <span class="mi-ic" aria-hidden="true">
                <svg class="mi-svg" viewBox="0 0 24 24"><path d="M3 10.5l9-7 9 7" /><path d="M5 10v9h14v-9" /></svg>
              </span>
              Panel
            </a>

            <a class="mi" role="menuitem" href="#" id="profileLink">
              <span class="mi-ic" aria-hidden="true">
                <svg class="mi-svg" viewBox="0 0 24 24"><path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4Z" /><path d="M4 20a8 8 0 0 1 16 0" /></svg>
              </span>
              Mi perfil
            </a>

            <a class="mi" role="menuitem" href="#" id="pwdInlineLink">
              <span class="mi-ic" aria-hidden="true">
                <svg class="mi-svg" viewBox="0 0 24 24"><path d="M7 10V8a5 5 0 0 1 10 0v2" /><rect x="5" y="10" width="14" height="10" rx="2" ry="2" /></svg>
              </span>
              Cambiar contrase√±a
            </a>

            <a class="mi" role="menuitem" href="#" id="addUserOpen">
              <span class="mi-ic" aria-hidden="true">
                <svg class="mi-svg" viewBox="0 0 24 24"><path d="M16 21a8 8 0 0 0-16 0" /><circle cx="8" cy="7" r="4" /><path d="M19 8v6" /><path d="M22 11h-6" /></svg>
              </span>
              Agregar usuario (admin)
            </a>

            <div class="sep" aria-hidden="true"></div>

            <a class="mi mi-danger" role="menuitem" href="#" id="logoutOpen">
              <span class="mi-ic" aria-hidden="true">
                <svg class="mi-svg" viewBox="0 0 24 24"><path d="M9 21H6a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h3" /><path d="M16 17l5-5-5-5" /><path d="M21 12H9" /></svg>
              </span>
              Cerrar sesi√≥n
            </a>
          </nav>

          <form id="logoutForm" method="post" action="{% url 'administracion:logout' %}" class="is-hidden">
            {% csrf_token %}
            <input type="hidden" name="next" value="{% url 'administracion:login' %}">
            <noscript><button type="submit">Cerrar sesi√≥n</button></noscript>
          </form>
        </div>
      </div>
    </header>

    <!-- Contenido -->
    <main class="main">
      <!-- KPIs -->
      <section class="kpis" aria-label="Indicadores">
        <div class="kpi"><div class="kpi-label">Solicitudes</div><div class="kpi-value">{{ total_requests|default:0 }}</div></div>
        <div class="kpi"><div class="kpi-label">Pendientes</div><div class="kpi-value warn">{{ pending|default:0 }}</div></div>
        <div class="kpi"><div class="kpi-label">Aprobadas</div><div class="kpi-value ok">{{ accepted|default:0 }}</div></div>
        <div class="kpi"><div class="kpi-label">Rechazadas</div><div class="kpi-value bad">{{ rejected|default:0 }}</div></div>
        <div class="kpi"><div class="kpi-label">Graduados</div><div class="kpi-value">{{ total_graduates|default:0 }}</div></div>
      </section>

      <!-- Acciones r√°pidas -->
      <section class="quick" aria-label="Acciones r√°pidas">
        <!-- ‚úÖ ahora apunta al tablero de solicitudes del admin -->
        <a class="qbtn" href="{% url 'administracion:requests_board' %}">Solicitudes</a>
        <a class="qbtn" href="{% url 'administracion:egresados' %}">Egresados</a>
        <a class="qbtn" href="{% url 'administracion:plantillas' %}">Plantillas</a>
        <a class="qbtn" href="#">Mensajes de Correo</a>
      </section>

      <div class="grid">
        <!-- √öltimas solicitudes -->
        <section class="card card--wide" aria-label="√öltimas solicitudes">
          <div class="card-head">
            <h2 class="card-title">√öltimas solicitudes</h2>
            {% if not q %}<a class="link" href="{% url 'administracion:home' %}?q=">Ver m√°s</a>{% endif %}
          </div>

          <div class="table-wrap" role="region" aria-label="Tabla de solicitudes" tabindex="0">
            <table class="t t--clean t--center">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Nombre</th>
                  <th>Correo</th>
                  <th>Programa</th>
                  <th>Estatus</th>
                </tr>
              </thead>
              <tbody>
                {% for r in recent_requests %}
                <tr class="rowlink" data-href="{% url 'alumnos:tracking' r.id %}">
                  <td class="t-col t-date">{{ r.sent_at|date:"Y-m-d H:i" }}</td>
                  <td class="t-col t-name">{{ r.name }} {{ r.lastname }}</td>
                  <td class="t-col t-mail muted"><a href="mailto:{{ r.email }}">{{ r.email }}</a></td>
                  <td class="t-col t-program">
                    {% if r.program.abbreviation %}<span class="badge">{{ r.program.abbreviation }}</span>{% endif %}
                    <span class="t-program-name">{{ r.program.name }}</span>
                  </td>
                  <td class="t-col">
                    {% if r.status == 'pending' %}
                      <span class="tag warn">Pendiente</span>
                    {% elif r.status == 'accepted' %}
                      <span class="tag ok">Aprobada</span>
                    {% elif r.status == 'rejected' %}
                      <span class="tag bad">Rechazada</span>
                    {% else %}
                      <span class="tag">{{ r.status }}</span>
                    {% endif %}
                  </td>
                </tr>
                {% empty %}
                <tr><td colspan="5" class="empty">Sin registros.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </section>

        <!-- Actividad de seguridad -->
        <section class="card" aria-label="Actividad de seguridad">
          <div class="card-head">
            <h2 class="card-title">Actividad reciente (seguridad)</h2>
            <a class="link" href="#">Ver todo</a>
          </div>
          <div class="timeline">
            {% for log in recent_logs %}
              <div class="trow">
                <div class="t-main">
                  <strong>{{ log.username }}</strong>
                  <span class="muted"> ‚Ä¢ {{ log.get_event_display|default:"Evento" }}</span>
                </div>
                <div class="t-sub muted">
                  {{ log.created_at|date:"Y-m-d H:i" }} ¬∑ IP {{ log.ip|default:"-" }}
                </div>
              </div>
            {% empty %}
              <div class="empty">Sin eventos.</div>
            {% endfor %}
          </div>
        </section>
      </div>
    </main>

    <footer class="foot">¬© {{ now|date:"Y" }} CES</footer>
  </div>

  <!-- ===== Modales ===== -->

  <!-- Modal: Cerrar sesi√≥n -->
  <div class="modal" id="logoutModal" aria-hidden="true" role="dialog" aria-modal="false" aria-labelledby="logoutTitle" aria-describedby="logoutDesc">
    <div class="modal__backdrop" id="logoutBackdrop"></div>
    <div class="modal__dialog">
      <div class="modal__bar" aria-hidden="true"></div>
      <button class="modal__close" id="logoutClose" aria-label="Cerrar">√ó</button>

      <div class="modal__icon" aria-hidden="true">‚éã</div>
      <h3 class="modal__title" id="logoutTitle">¬øSeguro que deseas cerrar sesi√≥n?</h3>
      <p class="modal__desc" id="logoutDesc">Se cerrar√° tu sesi√≥n actual y volver√°s a Acceso.</p>

      <div class="modal__actions">
        <button class="btn btn--primary" id="logoutConfirm">S√≠, cerrar sesi√≥n</button>
        <button class="btn btn--secondary" id="logoutCancel" type="button">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal: Mi perfil -->
  <div class="modal" id="profileModal" aria-hidden="true" role="dialog" aria-modal="false" aria-labelledby="profileTitle">
    <div class="modal__backdrop" data-close="#profileModal"></div>
    <div class="modal__dialog modal--sm">
      <div class="modal__bar" aria-hidden="true"></div>
      <button class="modal__close" data-close="#profileModal" aria-label="Cerrar">√ó</button>

      <div class="modal__icon" aria-hidden="true">üë§</div>
      <h3 class="modal__title" id="profileTitle">Mi perfil</h3>
      <p class="modal__desc">Vista previa de tu cuenta.</p>

      <div class="field field--compact">
        <label>Usuario</label>
        <input class="input input--neo input--xs" type="text" value="{{ request.user.username }}" readonly>
      </div>
      <div class="field field--compact">
        <label>Correo</label>
        <input class="input input--neo input--xs" type="text" value="{{ request.user.email }}" readonly>
      </div>
      <div class="field field--compact">
        <label>Nombre</label>
        <input class="input input--neo input--xs" type="text" value="{{ request.user.first_name }} {{ request.user.last_name }}" readonly>
      </div>

      <div class="field field--compact">
        <div class="lastseen" role="status" aria-live="polite">
          <div class="lastseen-ic" aria-hidden="true">
            <svg viewBox="0 0 24 24" width="18" height="18">
              <circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="1.5"/>
              <path d="M12 7v5l3 3" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            </svg>
          </div>
          <div class="lastseen-txt">
            <div class="ls-cap">√öltimo acceso</div>
            <div class="ls-main">{{ request.user.last_login|date:"Y-m-d H:i" }}</div>
            <div class="ls-sub">{{ request.user.last_login|timesince }} atr√°s</div>
          </div>
        </div>
      </div>

      <div class="modal__actions">
        <button class="btn btn--secondary" data-close="#profileModal">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Modal: Cambiar contrase√±a -->
  <div class="modal" id="pwdModal" aria-hidden="true" role="dialog" aria-modal="false" aria-labelledby="pwdTitle">
    <div class="modal__backdrop" data-close="#pwdModal"></div>
    <div class="modal__dialog modal--sm">
      <div class="modal__bar" aria-hidden="true"></div>
      <button class="modal__close" data-close="#pwdModal" aria-label="Cerrar">√ó</button>

      <div class="modal__icon" aria-hidden="true">üîí</div>
      <h3 class="modal__title" id="pwdTitle">Cambiar contrase√±a</h3>
      <p class="modal__desc">Escribe y confirma tu nueva contrase√±a.</p>

      <form id="pwdForm" method="post" action="{% url 'administracion:password_change_inline' %}">
        {% csrf_token %}
        <div class="field field--compact">
          <label for="id_new_password1">Nueva contrase√±a</label>
          <input class="input input--neo input--xs" id="id_new_password1" name="new_password1" type="password" minlength="8" required>
        </div>
        <div class="field field--compact">
          <label for="id_new_password2">Confirmar contrase√±a</label>
          <input class="input input--neo input--xs" id="id_new_password2" name="new_password2" type="password" minlength="8" required>
        </div>
        <div id="pwdMsg" class="form-msg" aria-live="polite"></div>

        <div class="modal__actions">
          <button class="btn btn--primary" type="submit">Guardar</button>
          <button class="btn btn--secondary" type="button" data-close="#pwdModal">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Agregar usuario (admin) -->
  <div class="modal" id="addUserModal" aria-hidden="true" role="dialog" aria-modal="false" aria-labelledby="addUserTitle">
    <div class="modal__backdrop" data-close="#addUserModal"></div>
    <div class="modal__dialog">
      <div class="modal__bar" aria-hidden="true"></div>
      <button class="modal__close" data-close="#addUserModal" aria-label="Cerrar">√ó</button>

      <div class="modal__icon" aria-hidden="true">‚ûï</div>
      <h3 class="modal__title" id="addUserTitle">Agregar usuario (admin)</h3>
      <p class="modal__desc">Crea un nuevo administrador para el panel.</p>

      <form id="addUserForm" method="post" action="{% url 'administracion:create_admin_inline' %}" autocomplete="off">
        {% csrf_token %}

        <div class="grid-2 grid-compact">
          <div class="field field--compact">
            <label for="au_email">Correo</label>
            <input class="input input--neo input--xs" id="au_email" name="email" type="email" required>
          </div>

          <div class="field field--compact">
            <label for="au_username">Usuario</label>
            <input class="input input--neo input--xs" id="au_username" name="username" type="text">
            <small class="hint">Se sugiere a partir del correo</small>
          </div>
        </div>

        <div class="grid-2 grid-compact">
          <div class="field field--compact">
            <label for="au_first">Nombre(s)</label>
            <input class="input input--neo input--xs" id="au_first" name="first_name" type="text">
          </div>
          <div class="field field--compact">
            <label for="au_last">Apellidos</label>
            <input class="input input--neo input--xs" id="au_last" name="last_name" type="text">
          </div>
        </div>

        <div class="grid-2 grid-compact">
          <div class="field field--compact">
            <label for="au_pw1">Contrase√±a</label>
            <input class="input input--neo input--xs" id="au_pw1" name="password1" type="password" minlength="8" required>
          </div>
          <div class="field field--compact">
            <label for="au_pw2">Confirmar contrase√±a</label>
            <input class="input input--neo input--xs" id="au_pw2" name="password2" type="password" minlength="8" required>
          </div>
        </div>

        <div id="auMsg" class="form-msg" aria-live="polite"></div>

        <div class="modal__actions">
          <button class="btn btn--primary" type="submit">Crear usuario</button>
          <button class="btn btn--secondary" type="button" data-close="#addUserModal">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- JS -->
  <script src="{% static 'js/admin_home.js' %}?v={{ now|date:'U' }}" defer></script>
</body>
</html>
