{% load static %}
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Plantillas · Administración</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Favicons -->
  <link rel="icon" href="{% static 'favicon/favicon.ico' %}?v=1">

  <!-- Estilos -->
  <link rel="stylesheet" href="{% static 'css/plantillas.css' %}">

  <!-- JS -->
  <script src="{% static 'js/plantillas_admin.js' %}" defer></script>
</head>

<body class="bg-orbs">
<div class="app">

  <!-- ========================= APP BAR ========================= -->
  <header class="appbar">
    <div class="appbar__left">
      <div class="brand" aria-label="Plantillas CES">
        <span class="dot"></span><strong>Plantillas</strong>
      </div>

      <!-- Buscador -->
      <form method="get" class="searchbar" onsubmit="return false">
        <input id="tpl-search" class="searchbar__input" type="search"
               placeholder="Buscar por título o tipo…">
      </form>
    </div>

    <nav class="appbar__right">

      <!-- Importar diseño / imágenes -->
      <form id="importForm"
            action="{% url 'administracion:plantilla_import' %}"
            method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <input id="importFile" name="file" type="file" hidden
               accept=".pdf,.doc,.docx,.ppt,.pptx,.odt,.odp,.png,.jpg,.jpeg,.webp,.svg">
        <button type="button" id="btnImport" class="btn btn--primary btn--sm">
          Abrir/Importar…
        </button>
      </form>

      <!-- Importar DOCX con variables -->
      <form id="importDocxTplForm"
            action="{% url 'administracion:docx_template_import' %}"
            method="post" enctype="multipart/form-data"
            class="import-docx-tpl">
        {% csrf_token %}
        <input id="importDocxTplFile" name="file" type="file" hidden accept=".doc,.docx">

        <!-- valor real que se manda al backend -->
        <input type="hidden" name="tipo" id="docxTplTipo" value="diploma">

        <!-- Dropdown custom oscuro -->
        <div class="docx-select" id="docxSelect">
          <button type="button" class="docx-select__trigger" aria-haspopup="listbox" aria-expanded="false">
            <span id="docxSelectLabel">Diploma (DOCX con variables)</span>
            <span class="docx-select__chevron">▾</span>
          </button>
          <ul class="docx-select__menu" role="listbox">
            <li class="docx-select__option is-active" data-value="diploma">
              Diploma (DOCX con variables)
            </li>
            <li class="docx-select__option" data-value="dc3">
              Constancia DC3 (DOCX con variables)
            </li>
            <li class="docx-select__option" data-value="cproem">
              CPROEM (DOCX con variables)
            </li>
          </ul>
        </div>
      </form>

      <a class="btn btn--sm" href="{% url 'administracion:plantillas' %}">Panel</a>
    </nav>
  </header>

  <!-- ========================= CONTENIDO ========================= -->
  <main class="content content--wide">
    <h1 class="h1">Administración de plantillas</h1>
    <p class="sub">Importa documentos o elimina las plantillas que ya no se usen. Se debe utilizar el siguiente tipo de variable dentro del documento para que 
    el sistema pueda leerlas y adjuntar la informacion: [nombre],[apellido],[curp],[rfc],[puesto],[giro],[razon_social],[email],[programa],[horas],[fecha_inicio],[fecha_fin],[fecha_inicio_letra]
    [fecha_fin_letra],[inicio_dia],[inicio_mes],[inicio_anio],[fin_dia],[fin_mes],[fin_anio],[verificacion_url],[fecha_inicio_letra_may] y [fecha_fin_letra_may] para mayor facilidad poner la variable del color y formato de letra antes de subirlo.
    </p>

    <!-- Mensajes de estado -->
    {% if messages %}
      <div class="alerts">
        {% for message in messages %}
          <div class="alert 
               {% if 'success' in message.tags %}alert--success{% endif %}
               {% if 'error' in message.tags or 'danger' in message.tags %}alert--danger{% endif %}
               {% if 'warning' in message.tags %}alert--warning{% endif %}
               {% if 'info' in message.tags %}alert--info{% endif %}">
            <span class="alert__dot"></span>
            <span class="alert__text">{{ message }}</span>
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <!-- ========================= FILTROS ========================= -->
    <div class="filterbar">
      <span class="filterbar__label">Vistas:</span>

      <div class="chips" id="kind-filter">
        <button class="chip is-active" data-kind="">Todo</button>
        <button class="chip" data-kind="design">Diplomas</button>
        <button class="chip" data-kind="cproem">CPROEM</button>
        <button class="chip" data-kind="dc3">DC3</button>
      </div>
    </div>

    <!-- ========================= PLANTILLAS DISEÑO ========================= -->
    <section class="cards cards--word" id="tpl-grid">
      {% for t in items %}
        <article class="card card--tpl"
                 data-json='{{ t.json_active|default:"{}"|escapejs }}'
                 data-title="{{ t.title }}"
                 data-kind="{{ t.kind }}">

          <div class="thumb">
            {% if t.thumb %}
              <img class="thumb__img" src="{{ t.thumb.url }}">
            {% else %}
              <canvas class="tpl"></canvas>
            {% endif %}
          </div>

          <div class="card__meta">
            <h3 class="card__title">{{ t.title }}</h3>
            <div class="card__sub">
              <span class="pill">{{ t.kind }}</span>
              <span class="muted">• {{ t.updated_at|date:"d/m/Y H:i" }}</span>
            </div>
          </div>

          <div class="card__actions">
            <form method="post"
                  action="{% url 'administracion:plantilla_delete' t.id %}"
                  class="js-confirm"
                  data-confirm="¿Seguro que deseas eliminar «{{ t.title }}»?">
              {% csrf_token %}
              <button class="btn btn--danger btn--sm">Eliminar</button>
            </form>
          </div>
        </article>
      {% endfor %}
    </section>

    <!-- ========================= PLANTILLAS DOCX ========================= -->
    <section class="section-docx">
      <h2 class="h2">Plantillas DOCX con variables</h2>
      <p class="sub">Plantillas DOCX utilizadas para generar diplomas y constancias.</p>

      <section class="cards cards--word" id="docx-grid">
        {% for d in docx_items %}
          <article class="card card--tpl card--tpl-docx"
                   data-title="{{ d.name }}"
                   data-kind="{% if d.tipo == 'diploma' %}diploma{% elif d.tipo == 'cproem' %}cproem{% elif d.tipo == 'dc3' %}dc3{% else %}otro{% endif %}">

            <div class="thumb">
              <img class="thumb__img"
                   src="{% url 'administracion:docx_template_preview' d.id %}">
            </div>

            <div class="card__meta">
              <h3 class="card__title">{{ d.name }}</h3>
              <div class="card__sub">
                <span class="pill">
                  {% if d.tipo == 'diploma' %}Diploma{% endif %}
                  {% if d.tipo == 'cproem' %}Constancia CPROEM{% endif %}
                  {% if d.tipo == 'dc3' %}Constancia DC-3{% endif %}
                </span>
                <span class="muted">• {{ d.created_at|date:"d/m/Y H:i" }}</span>
              </div>
            </div>

            <div class="card__actions">
              <form method="post"
                    action="{% url 'administracion:docx_template_delete' d.id %}"
                    class="js-confirm"
                    data-confirm="¿Eliminar plantilla DOCX «{{ d.name }}»?">
                {% csrf_token %}
                <button class="btn btn--danger btn--sm">Eliminar</button>
              </form>
            </div>

          </article>
        {% endfor %}
      </section>
    </section>

    <footer class="foot">
      © {{ now|date:"Y" }} Centro de Estudios Superiores en Negocios y Humanidades
    </footer>
  </main>
</div>

<!-- ========================= MODAL CONFIRM ========================= -->
<div id="confirmModal" class="c-modal" aria-hidden="true">
  <div class="c-modal__backdrop"></div>
  <div class="c-modal__panel" role="dialog">
    <h2 class="c-modal__title">Confirmar eliminación</h2>
    <p id="confirmText"></p>
    <div class="c-modal__actions">
      <button id="confirmCancel" class="btn btn--subtle">Cancelar</button>
      <button id="confirmOk" class="btn btn--danger">Eliminar</button>
    </div>
  </div>
</div>

<!-- ========================= MODAL IMPORT MODE ========================= -->
<div id="importModeModal" class="c-modal" aria-hidden="true">
  <div class="c-modal__backdrop"></div>
  <div class="c-modal__panel" role="dialog">
    <h2 class="c-modal__title">¿Cómo quieres importar tu documento?</h2>
    <p class="c-modal__text">Elige el tipo de importación que quieres usar.</p>

    <div class="import-mode__options">
      <button id="importModeDesign" class="btn btn--primary import-mode__option">
        <strong>Diseño / imagen de fondo</strong>
        <span>PDF, DOCX, PPTX o imágenes.</span>
      </button>

      <button id="importModeDocxTpl" class="btn btn--subtle import-mode__option">
        <strong>Plantilla DOCX con variables</strong>
        <span>Usa un DOCX con [placeholders].</span>
      </button>
    </div>

    <div class="c-modal__actions">
      <button class="btn btn--subtle" data-import-cancel>Cerrar</button>
    </div>
  </div>
</div>

</body>
</html>
