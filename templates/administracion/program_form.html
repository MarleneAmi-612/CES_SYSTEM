{% load static %}
<!DOCTYPE html>
<html lang="es-mx">
  <head>
    <meta charset="utf-8" />
    <title>
      {% if mode == "edit" %}
        Editar programa
      {% else %}
        Nuevo programa
      {% endif %}
    </title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="{% static 'favicon/favicon.ico' %}">
    <link rel="stylesheet" href="{% static 'css/programs.css' %}">
  </head>

  <body class="bg-orbs">
    <div class="page page--program-form">

      <!-- ENCABEZADO SUPERIOR -->
      <section class="card">
        <header class="card__header">
          <div class="card__header-left">
            <h1 class="card__title">
              {% if mode == "edit" %}
                Editar programa
              {% else %}
                Nuevo programa
              {% endif %}
            </h1>
            <p class="card__subtitle">
              Define el código, nombre y tipo de constancia del programa.
            </p>
          </div>

          <div class="card__header-right">
            <a href="{% url 'administracion:program_list' %}" class="btn btn--ghost">
              ← Volver a la lista
            </a>
            <button
              type="submit"
              form="programForm"
              class="btn btn--primary"
            >
              Guardar programa
            </button>
          </div>
        </header>
      </section>

      <!-- ALERTAS (Django messages) -->
      {% if messages %}
        <section class="alert-stack">
          {% for message in messages %}
            <div class="alert alert--{{ message.tags|default:'info' }}">
              <button
                type="button"
                class="alert__close"
                aria-label="Cerrar notificación"
              >
                ×
              </button>
              <span class="alert__text">{{ message }}</span>
              <div class="alert__progress">
                <div class="alert__progress-bar"></div>
              </div>
            </div>
          {% endfor %}
        </section>
      {% endif %}

      <!-- FORMULARIO PRINCIPAL -->
      <section class="card card--secondary">
        <header class="card__header card__header--small">
          <h2 class="card__title">
            Datos del programa
          </h2>
        </header>

        <div class="card__body">
          <form
            id="programForm"
            method="post"
            action=""
            class="form form--stacked"
          >
            {% csrf_token %}

            <!-- Errores generales (si los hubiera) -->
            {% if form and form.non_field_errors %}
              <div class="alert alert--error">
                {% for e in form.non_field_errors %}
                  <div>{{ e }}</div>
                {% endfor %}
              </div>
            {% endif %}

            <!-- Código + Nombre -->
            <div class="form__grid">
              <div class="field">
                <label for="code" class="field__label">Código</label>
                <input
                  id="code"
                  name="code"
                  type="text"
                  class="field__input"
                  placeholder="Ej. DETN-01"
                  value="{{ item.code|default_if_none:'' }}"
                  required
                >
                <p class="field__help">
                  Identificador corto del programa. Se usa en folios y vínculos.
                </p>
              </div>

              <div class="field">
                <label for="name" class="field__label">Nombre completo</label>
                <input
                  id="name"
                  name="name"
                  type="text"
                  class="field__input"
                  placeholder="Nombre del diplomado o curso"
                  value="{{ item.name|default_if_none:'' }}"
                  required
                >
                <p class="field__help">
                  Nombre tal como aparecerá en diplomas y constancias.
                </p>
              </div>
            </div>

            <!-- Tipo de constancia -->
            <div class="field">
              <label for="constancia_type" class="field__label">
                Tipo de constancia
              </label>

              <select
                id="constancia_type"
                name="constancia_type"
                class="field__input field__input--select-dark"
              >
                <option
                  value="cproem"
                  {% if item.constancia_type == "cproem" or not item.constancia_type %}selected{% endif %}
                >
                  CEPROEM
                </option>
                <option
                  value="dc3"
                  {% if item.constancia_type == "dc3" %}selected{% endif %}
                >
                  DC3
                </option>
              </select>

              <p class="field__help">
                Define si las constancias emitidas serán CEPROEM o DC3.
              </p>
            </div>

            <!-- Plantilla de diploma (combinada DISEÑO + DOCX) -->
            <div class="field">
              <label for="tpl_diploma_combined" class="field__label">
                Plantilla de diploma
              </label>

              <!-- Select visible combinado -->
              <select
                id="tpl_diploma_combined"
                class="field__input field__input--select-dark"
              >
                <option value="">
                  — Sin plantilla asignada —
                </option>

                <optgroup label="Plantillas de diseño">
                  {% for tpl in plantillas %}
                    {% if tpl.kind == "design" or tpl.kind == "diploma" %}
                      <option
                        value="design:{{ tpl.id }}"
                        data-src="design"
                        data-id="{{ tpl.id }}"
                      >
                        {{ tpl.title }}
                      </option>
                    {% endif %}
                  {% endfor %}
                </optgroup>

                <optgroup label="Plantillas DOCX con variables">
                  {% for tpl in docx_diploma_templates %}
                    <option
                      value="docx:{{ tpl.id }}"
                      data-src="docx"
                      data-id="{{ tpl.id }}"
                    >
                      {{ tpl.name }}
                    </option>
                  {% endfor %}
                </optgroup>
              </select>

              <!-- Campos reales que el backend espera -->
              <input
                type="hidden"
                name="plantilla_diploma"
                id="plantilla_diploma"
                value="{{ item.plantilla_diploma_id|default_if_none:'' }}"
              >
              <input
                type="hidden"
                name="docx_tpl_diploma"
                id="docx_tpl_diploma"
                value="{{ item.docx_tpl_diploma_id|default_if_none:'' }}"
              >

              <p class="field__help">
                Puedes usar una plantilla gráfica o una plantilla DOCX con variables para el diploma.
              </p>
            </div>

            <!-- Plantilla de constancia (combinada DISEÑO + DOCX) -->
            <div class="field">
              <label for="tpl_constancia_combined" class="field__label">
                Plantilla de constancia
              </label>

              <!-- Select visible combinado -->
              <select
                id="tpl_constancia_combined"
                class="field__input field__input--select-dark"
              >
                <option value="">
                  — Sin plantilla asignada —
                </option>

                <!-- Diseño DC3 -->
                <optgroup label="Plantillas DC3 (diseño)">
                  {% for tpl in plantillas %}
                    {% if tpl.kind == "dc3" %}
                      <option
                        value="design:{{ tpl.id }}"
                        data-src="design"
                        data-id="{{ tpl.id }}"
                        data-kind="dc3"
                      >
                        {{ tpl.title }}
                      </option>
                    {% endif %}
                  {% endfor %}
                </optgroup>

                <!-- Diseño CPROEM -->
                <optgroup label="Plantillas CPROEM (diseño)">
                  {% for tpl in plantillas %}
                    {% if tpl.kind == "cproem" %}
                      <option
                        value="design:{{ tpl.id }}"
                        data-src="design"
                        data-id="{{ tpl.id }}"
                        data-kind="cproem"
                      >
                        {{ tpl.title }}
                      </option>
                    {% endif %}
                  {% endfor %}
                </optgroup>

                <!-- DOCX DC3 -->
                <optgroup label="Plantillas DOCX DC3">
                  {% for tpl in docx_dc3_templates %}
                    <option
                      value="docx_dc3:{{ tpl.id }}"
                      data-src="docx_dc3"
                      data-id="{{ tpl.id }}"
                      data-kind="dc3"
                    >
                      {{ tpl.name }}
                    </option>
                  {% endfor %}
                </optgroup>

                <!-- DOCX CPROEM -->
                <optgroup label="Plantillas DOCX CPROEM">
                  {% for tpl in docx_cproem_templates %}
                    <option
                      value="docx_cproem:{{ tpl.id }}"
                      data-src="docx_cproem"
                      data-id="{{ tpl.id }}"
                      data-kind="cproem"
                    >
                      {{ tpl.name }}
                    </option>
                  {% endfor %}
                </optgroup>
              </select>

              <!-- Campos reales que el backend espera -->
              <input
                type="hidden"
                name="plantilla_constancia"
                id="plantilla_constancia"
                value="{{ item.plantilla_constancia_id|default_if_none:'' }}"
              >
              <input
                type="hidden"
                name="docx_tpl_dc3"
                id="docx_tpl_dc3"
                value="{{ item.docx_tpl_dc3_id|default_if_none:'' }}"
              >
              <input
                type="hidden"
                name="docx_tpl_cproem"
                id="docx_tpl_cproem"
                value="{{ item.docx_tpl_cproem_id|default_if_none:'' }}"
              >

              <p class="field__help">
                Dependiendo del tipo de constancia (DC3 / CPROEM) puedes usar diseño o DOCX con variables.
              </p>
            </div>

            <!-- Acciones inferiores -->
            <div class="form__actions">
              <a
                href="{% url 'administracion:program_list' %}"
                class="btn btn--ghost"
              >
                Cancelar
              </a>
              <button type="submit" class="btn btn--primary">
                Guardar programa
              </button>
            </div>
          </form>
        </div>
      </section>
    </div>

    <!-- Scripts externos (sin inline, para no romper CSP) -->
    <script nonce="{{ csp_nonce }}" src="{% static 'js/program.js' %}" defer></script>
    <script nonce="{{ csp_nonce }}" src="{% static 'js/program_form.js' %}" defer></script>
  </body>
</html>
