{% load static %}
<!DOCTYPE html>
<html lang="es-mx">
  <head>
    <meta charset="utf-8" />
    <title>Gestión de programas</title>

    <!-- CSS -->
    <link rel="stylesheet" href="{% static 'css/programs.css' %}">

    <!-- JS -->
    <script defer src="{% static 'js/program.js' %}"></script>
    <script defer src="{% static 'js/program_edit.js' %}"></script>
  </head>

  <body class="bg-orbs">
    <div class="page">

      <!-- ENCABEZADO PRINCIPAL -->
      <header class="page__header">
        <h1 class="page__title">Gestión de programas</h1>
      </header>

      <!-- ALERTAS (éxito / error con cierre manual y barra de progreso) -->
      {% if messages %}
        <section class="alert-stack">
          {% for message in messages %}
            <div class="alert alert--{{ message.tags|default:'info' }}">
              <!-- Botón de cierre manual -->
              <button
                type="button"
                class="alert__close"
                aria-label="Cerrar notificación"
              >
                ×
              </button>

              <!-- Texto del mensaje -->
              <span class="alert__text">{{ message }}</span>

              <!-- Barra de progreso (10s) -->
              <div class="alert__progress">
                <div class="alert__progress-bar"></div>
              </div>
            </div>
          {% endfor %}
        </section>
      {% endif %}

      <!-- CONTENEDOR PRINCIPAL -->
      <main class="page__content">
        <section class="card">
          <header class="card__header">
            <div class="card__header-left">
              <form method="get" action="" class="search-form">
                <input
                  id="q"
                  type="text"
                  name="q"
                  class="search-form__input"
                  placeholder="Buscar programa..."
                  value="{{ q|default:'' }}"
                >
                <button type="submit" class="btn btn--primary btn-sm">
                  Buscar
                </button>
              </form>
            </div>

            <div class="card__header-right">
              <a
                href="{% url 'administracion:program_create' %}"
                class="btn btn--primary"
              >
                + Nuevo programa
              </a>
            </div>

              <!-- VOLVER A PLANTILLAS ADMIN -->
            <a
              href="{% url 'administracion:plantillas' %}"
              class="btn btn--ghost"
            >
              ← Volver a plantillas admin
            </a>
            </div>
          </header>


          <div class="card__body">
            <div class="table-wrapper">
              <table class="table table--programs">
                <thead class="table__head">
                  <tr>
                    <th class="table__cell">ID</th>
                    <th class="table__cell">Programa</th>
                    <th class="table__cell">Nombre completo</th>
                    <th class="table__cell">Constancia</th>
                    <th class="table__cell">Acciones</th>
                  </tr>
                </thead>
                <tbody class="table__body">
                  {% for d in sim_programs %}
                    <tr data-id="{{ d.id }}">
                      <td class="table__cell js-col-id">{{ d.id }}</td>
                      <td class="table__cell js-col-code">{{ d.programa }}</td>
                      <td class="table__cell js-col-name">{{ d.programa_full }}</td>
                      <td class="table__cell js-col-constancia">{{ d.constancia }}</td>
                      <td class="table__cell table__cell--actions">

                        <!-- EDITAR (abre modal AJAX) -->
                        <button
                          type="button"
                          class="btn btn--ghost btn-sm js-program-edit"
                          data-id="{{ d.id }}"
                          data-code="{{ d.programa }}"
                          data-name="{{ d.programa_full }}"
                          data-constancia="{{ d.constancia }}"
                          data-diploma-tpl="{{ d.tpl_diploma_id|default_if_none:'' }}"
                          data-dc3-front="{{ d.tpl_dc3_front_id|default_if_none:'' }}"
                          data-dc3-back="{{ d.tpl_dc3_back_id|default_if_none:'' }}"
                          data-cproem-tpl="{{ d.tpl_cproem_id|default_if_none:'' }}"
                          data-url="{% url 'administracion:program_edit' d.program_admin_id %}"
                        >
                          Editar
                        </button>

                        <!-- BORRAR: abre modal y luego envía formulario -->
                        <form
                          id="del-{{ d.id }}"
                          method="post"
                          action="{% url 'administracion:program_delete' d.id %}"
                          class="inline"
                        >
                          {% csrf_token %}
                          <button
                            type="button"
                            class="btn btn--danger btn-sm js-del"
                            data-form-id="del-{{ d.id }}"
                            data-program="{{ d.programa }}"
                            data-code="{{ d.id }}"
                          >
                            Borrar
                          </button>
                        </form>
                      </td>
                    </tr>
                  {% empty %}
                    <tr>
                      <td class="table__cell table__cell--empty" colspan="5">
                        No hay programas en ces_simulacion.
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

            <!-- Paginador (llenado por program.js) -->
            <div
              id="programPager"
              class="pager"
              aria-label="Páginas de programas"
            ></div>
          </div>
        </section>
      </main>
    </div>

    <!-- MODAL DE CONFIRMACIÓN (BORRAR) -->
    <div id="confirmModal" class="confirm-modal is-hidden" aria-hidden="true">
      <div class="modal__overlay" data-modal-close></div>

      <div class="modal__dialog confirm-modal__box">
        <header class="confirm-modal__header">
          <h3 class="modal__title">Confirmar eliminación</h3>
        </header>

        <div class="confirm-modal__body">
          <p class="modal__text">
            ¿Seguro que deseas eliminar el programa
            <strong id="confirmName"></strong>?
          </p>
          <p class="confirm-modal__code">
            Código: <span id="confirmCode"></span>
          </p>
          <p class="confirm-modal__warning">
            Esta acción no se puede deshacer.
          </p>
        </div>

        <footer class="modal__actions">
          <button
            type="button"
            id="confirmNo"
            class="btn btn--ghost"
            data-modal-close
          >
            Cancelar
          </button>
          <button
            type="button"
            id="confirmYes"
            class="btn btn--danger"
          >
            Sí, borrar
          </button>
        </footer>
      </div>
    </div>

        <!-- MODAL DE EDICIÓN (AJAX) -->
    <div
      id="programEditModal"
      class="confirm-modal is-hidden"
      aria-hidden="true"
    >
      <div class="modal__overlay" data-modal-close></div>

      <div class="modal__dialog confirm-modal__box">
        <header class="confirm-modal__header">
          <h3 class="modal__title">Editar programa</h3>
        </header>

        <div class="confirm-modal__body">
          <form id="programEditForm" class="modal-form">
            <input type="hidden" id="editId">

            <div class="field">
              <label for="editCode" class="field__label">Programa (código)</label>
              <input id="editCode" type="text" class="field__input" required>
            </div>

            <div class="field">
              <label for="editName" class="field__label">Nombre completo</label>
              <input id="editName" type="text" class="field__input" required>
            </div>

            <div class="field">
              <span class="field__label">Constancia</span>
              <div class="field__inline">
                <label class="radio">
                  <input type="radio" name="editConstancia" value="dc3"> DC3
                </label>
                <label class="radio">
                  <input type="radio" name="editConstancia" value="cproem"> CPROEM
                </label>
              </div>
            </div>

            <!-- PLANTILLA DE DIPLOMA (HTML estático + DOCX con variables) -->
            <div class="field" id="fieldTplDiploma">
              <label for="editTplDiploma" class="field__label">Plantilla de diploma</label>
              <select id="editTplDiploma" class="field__input">
                <option value="">Selecciona una plantilla…</option>

                {% if diploma_templates %}
                  <optgroup label="Diplomas (HTML / imagen estática)">
                    {% for tpl in diploma_templates %}
                      <option value="design:{{ tpl.id }}">{{ tpl.title }}</option>
                    {% endfor %}
                  </optgroup>
                {% endif %}

                {% if docx_diploma_templates %}
                  <optgroup label="Diplomas DOCX con variables">
                    {% for tpl in docx_diploma_templates %}
                      <option value="docx:{{ tpl.id }}">{{ tpl.name }}</option>
                    {% endfor %}
                  </optgroup>
                {% endif %}
              </select>
            </div>

            <!-- PLANTILLA DE CONSTANCIA (UN SOLO SELECT) -->
            <div class="field" id="fieldTplConstancia">
              <label for="editTplConstancia" class="field__label">Plantilla de constancia</label>
              <select id="editTplConstancia" class="field__input">
                <option value="">Selecciona una plantilla…</option>

                {% if dc3_templates %}
                  <optgroup label="DC3 (HTML / imagen estática)">
                    {% for tpl in dc3_templates %}
                      <option
                        value="dc3:design:{{ tpl.id }}"
                        data-kind="dc3"
                        data-source="design"
                      >
                        {{ tpl.title }}
                      </option>
                    {% endfor %}
                  </optgroup>
                {% endif %}

                {% if docx_dc3_templates %}
                  <optgroup label="DC3 DOCX con variables">
                    {% for tpl in docx_dc3_templates %}
                      <option
                        value="dc3:docx:{{ tpl.id }}"
                        data-kind="dc3"
                        data-source="docx"
                      >
                        {{ tpl.name }}
                      </option>
                    {% endfor %}
                  </optgroup>
                {% endif %}

                {% if cproem_templates %}
                  <optgroup label="CPROEM (HTML / imagen estática)">
                    {% for tpl in cproem_templates %}
                      <option
                        value="cproem:design:{{ tpl.id }}"
                        data-kind="cproem"
                        data-source="design"
                      >
                        {{ tpl.title }}
                      </option>
                    {% endfor %}
                  </optgroup>
                {% endif %}

                {% if docx_cproem_templates %}
                  <optgroup label="CPROEM DOCX con variables">
                    {% for tpl in docx_cproem_templates %}
                      <option
                        value="cproem:docx:{{ tpl.id }}"
                        data-kind="cproem"
                        data-source="docx"
                      >
                        {{ tpl.name }}
                      </option>
                    {% endfor %}
                  </optgroup>
                {% endif %}
              </select>
            </div>
          </form>
        </div>

        <footer class="modal__actions">
          <button
            type="button"
            class="btn btn--ghost"
            data-modal-close
          >
            Cancelar
          </button>
          <button
            type="button"
            id="programEditSave"
            class="btn btn--primary"
          >
            Guardar cambios
          </button>
        </footer>
      </div>
    </div>
