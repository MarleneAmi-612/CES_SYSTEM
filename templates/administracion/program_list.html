{% load static %}
<!DOCTYPE html>
<html lang="es-mx">
  <head>
    <meta charset="utf-8" />
    <title>Gestión de programas</title>

    <!-- CSS -->
    <link rel="stylesheet" href="{% static 'css/programs.css' %}">

    <!-- JS -->
    <script defer src="{% static 'js/program.js' %}"></script>
    <script defer src="{% static 'js/program_edit.js' %}"></script>
  </head>

  <body class="bg-orbs">
    <div class="page">

      <!-- ENCABEZADO PRINCIPAL -->
      <header class="page__header">
        <h1 class="page__title">Gestión de programas</h1>
      </header>

      <!-- ALERTAS (éxito / error con cierre manual y barra de progreso) -->
      {% if messages %}
        <section class="alert-stack">
          {% for message in messages %}
            <div class="alert alert--{{ message.tags|default:'info' }}">
              <!-- Botón de cierre manual -->
              <button
                type="button"
                class="alert__close"
                aria-label="Cerrar notificación"
              >
                ×
              </button>

              <!-- Texto del mensaje -->
              <span class="alert__text">{{ message }}</span>

              <!-- Barra de progreso (10s) -->
              <div class="alert__progress">
                <div class="alert__progress-bar"></div>
              </div>
            </div>
          {% endfor %}
        </section>
      {% endif %}

      <!-- BARRA SUPERIOR: BUSCADOR + BOTONES -->
      <section class="card">
        <header class="card__header">
          <div class="card__header-left">
            <form method="get" action="" class="search-form">
              <input
                id="q"
                type="text"
                name="q"
                class="search-form__input"
                placeholder="Buscar programa..."
                value="{{ q|default:'' }}"
              >
              <button type="submit" class="btn btn--primary btn-sm">
                Buscar
              </button>
            </form>
          </div>

          <div class="card__header-right">
            <!-- NUEVO PROGRAMA -->
            <a href="{% url 'administracion:program_create' %}" class="btn btn--primary">
              + Nuevo programa
            </a>

            <!-- VOLVER A PLANTILLAS ADMIN -->
            <a href="{% url 'administracion:plantillas' %}" class="btn btn--ghost">
              ← Volver a plantillas admin
            </a>
          </div>
        </header>
      </section>

      <!-- TABLA: PROGRAMAS DE SIMULACIÓN (ces_simulacion.diplomado) -->
      <section class="card card--secondary">
        <header class="card__header card__header--small">
          <h2 class="card__title">Programas</h2>
        </header>

        <div class="card__body">
          <div class="table-wrapper">
            <table class="table table--programs">
              <thead class="table__head">
                <tr>
                  <th class="table__cell">ID</th>
                  <th class="table__cell">Programa</th>
                  <th class="table__cell">Nombre completo</th>
                  <th class="table__cell">Constancia</th>
                  <th class="table__cell">Acciones</th>
                </tr>
              </thead>
              <tbody class="table__body">
                {% for d in sim_programs %}
                  <tr data-id="{{ d.id }}">
                    <td class="table__cell js-col-id">{{ d.id }}</td>
                    <td class="table__cell js-col-code">{{ d.programa }}</td>
                    <td class="table__cell js-col-name">{{ d.programa_full }}</td>
                    <td class="table__cell js-col-constancia">{{ d.constancia }}</td>
                    <td class="table__cell table__cell--actions">

                      <!-- EDITAR (abre modal AJAX) -->
                      <button
                        type="button"
                        class="btn btn--ghost btn-sm js-program-edit"
                        data-id="{{ d.id }}"
                        data-code="{{ d.programa }}"
                        data-name="{{ d.programa_full }}"
                        data-constancia="{{ d.constancia }}"
                        data-diploma-tpl="{{ d.tpl_diploma_id|default_if_none:'' }}"
                        data-dc3-front="{{ d.tpl_dc3_front_id|default_if_none:'' }}"
                        data-dc3-back="{{ d.tpl_dc3_back_id|default_if_none:'' }}"
                        data-cproem-tpl="{{ d.tpl_cproem_id|default_if_none:'' }}"
                        data-url="{% url 'administracion:program_edit' d.program_admin_id %}"
                      >
                        Editar
                      </button>

                      <!-- BORRAR: abre modal y luego envía formulario -->
                      <form id="del-{{ d.id }}"
                            method="post"
                            action="{% url 'administracion:program_delete' d.id %}"
                            class="inline">
                        {% csrf_token %}
                        <button
                          type="button"
                          class="btn btn--danger btn-sm js-del"
                          data-form-id="del-{{ d.id }}"
                          data-program="{{ d.programa }}"
                          data-code="{{ d.id }}"
                        >
                          Borrar
                        </button>
                      </form>
                    </td>
                  </tr>
                {% empty %}
                  <tr>
                    <td class="table__cell table__cell--empty" colspan="5">
                      No hay programas en ces_simulacion.
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <!-- Paginador (llenado por program.js) -->
          <div id="programPager" class="pager" aria-label="Páginas de programas"></div>
        </div>
      </section>

    </div>

    <!-- MODAL DE CONFIRMACIÓN (BORRAR) -->
    <div id="confirmModal" class="confirm-modal is-hidden" aria-hidden="true">
      <div class="modal__overlay" data-modal-close></div>

      <div class="modal__dialog confirm-modal__box">
        <header class="confirm-modal__header">
          <h3 class="modal__title">Confirmar eliminación</h3>
        </header>

        <div class="confirm-modal__body">
          <p class="modal__text">
            ¿Seguro que deseas eliminar el programa
            <strong id="confirmName"></strong>?
          </p>
          <p class="confirm-modal__code">
            Código: <span id="confirmCode"></span>
          </p>
          <p class="confirm-modal__warning">
            Esta acción no se puede deshacer.
          </p>
        </div>

        <footer class="modal__actions">
          <button
            type="button"
            id="confirmNo"
            class="btn btn--ghost"
            data-modal-close
          >
            Cancelar
          </button>
          <button
            type="button"
            id="confirmYes"
            class="btn btn--danger"
          >
            Sí, borrar
          </button>
        </footer>
      </div>
    </div>

    <!-- MODAL DE EDICIÓN (AJAX) -->
    <div id="programEditModal" class="confirm-modal is-hidden" aria-hidden="true">
      <div class="modal__overlay" data-modal-close></div>

      <div class="modal__dialog confirm-modal__box">
        <header class="confirm-modal__header">
          <h3 class="modal__title">Editar programa</h3>
        </header>

        <div class="confirm-modal__body">
          <form id="programEditForm" class="modal-form">
            <input type="hidden" id="editId">

            <div class="field">
              <label for="editCode" class="field__label">Programa (código)</label>
              <input id="editCode" type="text" class="field__input" required>
            </div>

            <div class="field">
              <label for="editName" class="field__label">Nombre completo</label>
              <input id="editName" type="text" class="field__input" required>
            </div>

            <div class="field">
              <span class="field__label">Constancia</span>
              <div class="field__inline">
                <label class="radio">
                  <input type="radio" name="editConstancia" value="dc3"> DC3
                </label>
                <label class="radio">
                  <input type="radio" name="editConstancia" value="cproem"> CPROEM
                </label>
              </div>
            </div>

            <!-- NUEVO: PLANTILLA DE DIPLOMA -->
            <div class="field" id="fieldTplDiploma">
              <label for="editTplDiploma" class="field__label">Plantilla de diploma</label>
              <select id="editTplDiploma" class="field__input">
                <option value="">Selecciona una plantilla…</option>
                {% for tpl in diploma_templates %}
                  <option value="{{ tpl.id }}">{{ tpl.title }}</option>
                {% endfor %}
              </select>
              <p id="editTplDiplomaCurrent" class="field__help"></p>
            </div>

            <!-- BLOQUE: PLANTILLAS PARA DC3 (FRONTAL / REVERSO) -->
            <div class="field" id="fieldTplDc3">
              <span class="field__label">Plantillas DC3</span>

              <div class="field__inline field__inline--stack">
                <div class="field">
                  <label for="editTplDc3Front" class="field__label field__label--small">
                    Frontal (_F)
                  </label>
                  <select id="editTplDc3Front" class="field__input">
                    <option value="">Selecciona frontal…</option>
                    {% for tpl in dc3_templates %}
                      <option value="{{ tpl.id }}">{{ tpl.title }}</option>
                    {% endfor %}
                  </select>
                </div>

                <div class="field">
                  <label for="editTplDc3Back" class="field__label field__label--small">
                    Reverso (_R)
                  </label>
                  <select id="editTplDc3Back" class="field__input">
                    <option value="">Selecciona reverso…</option>
                    {% for tpl in dc3_templates %}
                      <option value="{{ tpl.id }}">{{ tpl.title }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>

              <p id="editTplDc3Current" class="field__help"></p>
            </div>

            <!-- BLOQUE: PLANTILLA PARA CPROEM (SOLO UNA) -->
            <div class="field" id="fieldTplCproem">
              <label for="editTplCproem" class="field__label">Plantilla CPROEM</label>
              <select id="editTplCproem" class="field__input">
                <option value="">Selecciona una plantilla…</option>
                {% for tpl in cproem_templates %}
                  <option value="{{ tpl.id }}">{{ tpl.title }}</option>
                {% endfor %}
              </select>
              <p id="editTplCproemCurrent" class="field__help"></p>
            </div>

          </form>
        </div>

        <footer class="modal__actions">
          <button
            type="button"
            class="btn btn--ghost"
            data-modal-close
          >
            Cancelar
          </button>
          <button
            type="button"
            id="programEditSave"
            class="btn btn--primary"
          >
            Guardar cambios
          </button>
        </footer>
      </div>
    </div>
  </body>
</html>
