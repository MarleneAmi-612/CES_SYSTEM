{% load static %}
<link rel="icon" href="{% static 'favicon/favicon.ico' %}">
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Solicitudes | Administraci√≥n Centro de Estudios Superiores en Negocios y Humanidades</title>

  <!-- Fuentes + estilos -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/admin.css' %}?v={{ now|date:'U' }}">
  <link rel="stylesheet" href="{% static 'css/solicitudes.css' %}?v={{ now|date:'U' }}">

  <!-- Tokens para el JS est√°tico -->
  <meta name="csrf-token" content="{{ csrf_token }}">
  <meta name="requests-update-url" content="{% url 'administracion:request_update_status' %}">
  <!-- Opcional / legacy: plantilla para borrar rechazadas v√≠a fetch -->
  <meta name="request-delete-url-template"
        content="{% url 'administracion:request_delete_rejected' 999999 %}">
</head>
<body class="bg-orbs">
<div class="shell">

  <!-- Contenedor de notificaciones (toasts) -->
  <div id="toast-root" class="toast-root" aria-live="polite" aria-atomic="true"></div>

  <!-- Topbar -->
  <header class="topbar">
    <div class="brand"><span class="dot"></span><strong>CES</strong> ¬∑ Solicitudes</div>
    <div class="top-actions">
      <a class="qbtn" href="{% url 'administracion:home' %}">Panel</a>
    </div>
  </header>

  <main class="main">

    <!-- Tabs por estado (default: pendientes) -->
    <nav class="tabs" aria-label="Estado">
      <a class="tab {% if estado == 'pending' or not estado %}is-active{% endif %}"
         href="{% url 'administracion:requests_board' %}?estado=pending">
        Pendientes <span class="badge">{{ counts.pending|default:0 }}</span>
      </a>
      <a class="tab {% if estado == 'review' %}is-active{% endif %}"
         href="{% url 'administracion:requests_board' %}?estado=review">
        Revisi√≥n <span class="badge">{{ counts.review|default:0 }}</span>
      </a>
      <a class="tab {% if estado == 'generating' %}is-active{% endif %}"
         href="{% url 'administracion:requests_board' %}?estado=generating">
        Generando <span class="badge">{{ counts.generating|default:0 }}</span>
      </a>
      <a class="tab {% if estado == 'accepted' %}is-active{% endif %}"
         href="{% url 'administracion:requests_board' %}?estado=accepted">
        Aceptadas <span class="badge">{{ counts.accepted|default:0 }}</span>
      </a>
      <a class="tab {% if estado == 'rejected' %}is-active{% endif %}"
         href="{% url 'administracion:requests_board' %}?estado=rejected">
        Rechazadas <span class="badge">{{ counts.rejected|default:0 }}</span>
      </a>
    </nav>

    <!-- Filtros adicionales (buscar y por programa) -->
    <form class="toolbar" method="get" action="">
      <input type="hidden" name="estado" value="{{ estado|default:'pending' }}">
      <div class="pill">
        <span>Buscar</span>
        <input class="tool-input" type="search" name="q" value="{{ q }}" placeholder="correo o nombre‚Ä¶">
      </div>

      <div class="pill">
        <span>Programa</span>
        <select name="program" onchange="this.form.submit()">
          <option value="">Todos</option>
          {% for p in programas %}
            <option value="{{ p.id }}" {% if program_id|default:'' == p.id|stringformat:'s' %}selected{% endif %}>
              {{ p.abbreviation|default:p.name }}
            </option>
          {% endfor %}
        </select>
      </div>

      <button class="btn btn--secondary" type="submit">Aplicar</button>
    </form>

    <!-- Tabla de resultados (lista filtrada en 'items') -->
    <section class="card card--wide">
      <div class="card-head">
        <h2 class="card-title">
          {% if estado == 'accepted' %}
            Aceptadas
          {% elif estado == 'rejected' %}
            Rechazadas
          {% elif estado == 'generating' %}
            Generando
          {% elif estado == 'review' %}
            Revisi√≥n
          {% else %}
            Pendientes
          {% endif %}
        </h2>
        <span class="muted">{{ items|length }} registros</span>
      </div>

      <div class="table-wrap" role="region" aria-label="Solicitudes" tabindex="0">
        <table class="t t--clean">
          <thead>
            <tr>
              <th>#</th>
              <th class="left">Alumno</th>
              <th>Correo</th>
              <th>Programa</th>
              <th>Enviado</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for r in items %}
              {% with full_name=r.name|add:" "|add:r.lastname program_lbl=r.program_name|default:"Sin programa" %}
              <tr id="row-{{ r.id }}">
                <td>{{ r.id }}</td>
                <td class="t-col left">{{ full_name }}</td>
                <td class="t-col"><a href="mailto:{{ r.email }}">{{ r.email }}</a></td>
                <td class="t-col">{{ program_lbl }}</td>
                <td class="t-col t-date">
                  {{ r.sent_at|date:"Y-m-d H:i" }}
                </td>
                <td class="t-col">
                  <span class="status-chip {{ r.status|default:'pending' }}" data-label>
                    {{ r.status|default:'pending' }}
                  </span>
                </td>
                <td class="t-col">
                  <div class="actions">
                    <!-- Bot√≥n Detalle con datos embebidos -->
                    <button class="a-btn ghost"
                            data-view="detail"
                            data-id="{{ r.id }}"
                            data-name="{{ r.name }}"
                            data-lastname="{{ r.lastname }}"
                            data-email="{{ r.email }}"
                            data-program="{{ program_lbl }}"
                            data-start="{{ r.start_date|date:'d/m/Y' }}"
                            data-end="{{ r.end_date|date:'d/m/Y' }}"
                            data-curp="{{ r.curp|default:'‚Äî' }}"
                            data-rfc="{{ r.rfc|default:'‚Äî' }}"
                            data-job_title="{{ r.job_title|default:'‚Äî' }}"
                            data-industry="{{ r.industry|default:'‚Äî' }}"
                            data-status="{{ r.status }}"
                            data-reason="{{ r.status_reason|default:'‚Äî' }}"
                    >Detalle</button>

                    <button class="a-btn warn"  data-action="to_review"  data-id="{{ r.id }}">Revisi√≥n</button>
                    <button class="a-btn ok"    data-action="approve"    data-id="{{ r.id }}">Aprobar</button>
                    <button class="a-btn bad"   data-action="reject"     data-id="{{ r.id }}">Rechazar</button>
                    <button class="a-btn"       data-action="generating" data-id="{{ r.id }}">Generando</button>

                    {# NUEVO: bot√≥n para borrar solicitudes RECHAZADAS #}
                    {% if r.status == 'rejected' %}
                      <form id="del-rej-{{ r.id }}"
                            method="post"
                            action="{% url 'administracion:request_delete_rejected' r.id %}"
                            class="inline-form">
                        {% csrf_token %}
                        <button type="button"
                                class="a-btn bad"
                                data-action="delete_rejected"
                                data-form-id="del-rej-{{ r.id }}"
                                data-alumno="{{ full_name }}">
                          Borrar rechazada
                        </button>
                      </form>
                    {% endif %}
                  </div>
                </td>
              </tr>
              {% endwith %}
            {% empty %}
              <tr><td colspan="7" class="empty">No hay solicitudes para mostrar.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>

  </main>

  <footer class="foot">¬© {{ now|date:"Y" }} Centro de Estudios Superiores en Negocios y Humanidades</footer>
</div>

<!-- Modal: Detalle bonito -->
<div class="modal modal--detail" id="detailModal" aria-hidden="true" role="dialog" aria-modal="false" aria-labelledby="detTitle">
  <div class="modal__backdrop" data-close="#detailModal"></div>
  <div class="modal__dialog modal--lg">
    <div class="modal__bar"></div>
    <button class="modal__close" data-close="#detailModal" aria-label="Cerrar">√ó</button>

    <h3 class="modal__title" id="detTitle">Detalle de la solicitud</h3>

    <input type="hidden" id="det_id">

    <div class="grid-2 gap">
      <div class="card flat">
        <div class="kv"><span class="k">Alumno</span><span class="v" id="det_name">‚Äî</span></div>
        <div class="kv"><span class="k">Correo</span><span class="v" id="det_email">‚Äî</span></div>
        <div class="kv"><span class="k">Programa</span><span class="v" id="det_program">‚Äî</span></div>
        <div class="kv"><span class="k">Periodo</span><span class="v" id="det_period">‚Äî</span></div>
      </div>

      <div class="card flat">
        <div class="kv"><span class="k">CURP</span><span class="v" id="det_curp">‚Äî</span></div>
        <div class="kv"><span class="k">RFC</span><span class="v" id="det_rfc">‚Äî</span></div>
        <div class="kv"><span class="k">Puesto</span><span class="v" id="det_job">‚Äî</span></div>
        <div class="kv"><span class="k">Giro</span><span class="v" id="det_industry">‚Äî</span></div>
      </div>
    </div>

    <div class="grid-2 gap">
      <div class="card flat">
        <div class="kv"><span class="k">Estado</span><span class="v chip" id="det_status">‚Äî</span></div>
      </div>
      <div class="card flat">
        <div class="kv"><span class="k">Motivo de rechazo</span><span class="v" id="det_reason">‚Äî</span></div>
      </div>
    </div>

    <div class="modal__actions modal__actions--split">
      <div class="left">
        <button class="btn" id="det_btn_review">Marcar revisi√≥n</button>
        <button class="btn" id="det_btn_generating">Marcar generando</button>
      </div>
      <div class="right">
        <button class="btn btn--primary" id="det_btn_approve">Aprobar</button>
        <button class="btn btn--danger"  id="det_btn_reject">Rechazar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Rechazar -->
<div class="modal" id="rejectModal" aria-hidden="true" role="dialog" aria-modal="false" aria-labelledby="rejTitle">
  <div class="modal__backdrop" data-close="#rejectModal"></div>
  <div class="modal__dialog modal--sm">
    <div class="modal__bar"></div>
    <button class="modal__close" data-close="#rejectModal" aria-label="Cerrar">√ó</button>
    <div class="modal__icon" aria-hidden="true">‚ö†Ô∏è</div>
    <h3 class="modal__title" id="rejTitle">¬øSeguro que desea rechazar?</h3>
    <p class="muted">Escriba el motivo del rechazo:</p>
    <form id="rejectForm">
      <input type="hidden" name="id" id="rej_id">
      <div class="field">
        <label for="rej_reason">Motivo</label>
        <textarea class="input" id="rej_reason" name="reason" rows="4" required></textarea>
      </div>
      <div id="rejMsg" class="form-msg"></div>
      <div class="modal__actions">
        <button class="btn btn--danger"    type="submit">Rechazar</button>
        <button class="btn btn--secondary" type="button" data-close="#rejectModal">Cancelar</button>
      </div>
    </form>
  </div>
</div>

<!-- NUEVO: Modal/overlay para borrar solicitudes rechazadas -->
<div id="deleteRejectOverlay"
     class="overlay is-hidden"
     aria-hidden="true"
     role="dialog"
     aria-modal="true">
  <div class="overlay__backdrop" data-del-dismiss="true"></div>
  <div class="overlay__dialog">
    <div class="overlay__icon" aria-hidden="true">üóëÔ∏è</div>
    <h2 class="overlay__title">Borrar solicitud rechazada</h2>
    <p class="overlay__text">
      ¬øBorrar definitivamente la solicitud rechazada de
      <strong id="delRejectName">este alumno</strong>?
    </p>
    <p class="overlay__text">
      Esta acci√≥n <strong>no se puede deshacer</strong>.<br>
      Si la persona desea solicitar de nuevo, tendr√° que llenar una nueva solicitud desde cero.
    </p>
    <div class="overlay__actions">
      <button type="button" class="btn" data-del-dismiss="true">Cancelar</button>
      <button type="button" class="btn btn--danger" id="delRejectConfirm">
        S√≠, borrar definitivamente
      </button>
    </div>
  </div>
</div>

<!-- JS de la p√°gina -->
<script src="{% static 'js/solicitudes.js' %}?v={{ now|date:'U' }}" defer></script>
</body>
</html>
